<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Counting Sheet PWA</title>
    <link rel="manifest" href="/manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => console.log('Service Worker registered.'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }
    </script>

    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --border-color: #dee2e6;
            --selected-color: #fff3cd;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f8f9fa;
            color: #212529;
            touch-action: pan-x pan-y;
        }

        .container {
            max-width: 900px;
            margin: auto;
        }

        .header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
        }

        .header input, .header button {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
        }

        .header button {
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
        }

        .header button:hover {
            background-color: #0056b3;
        }

        .header #time-interval {
            flex-grow: 1;
            text-align: right;
            font-weight: bold;
            color: var(--secondary-color);
        }

        .table-container {
            overflow: auto;
            max-height: 70vh;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin-bottom: 20px;
            background-color: white;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-x pan-y;
        }

        #data-table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            table-layout: auto; /* Changed to auto for content fitting */
            transform-origin: 0 0;
        }

        #data-table th, #data-table td {
            padding: 8px;
            text-align: center;
            white-space: nowrap;
            border: 1px solid var(--border-color);
        }

        #data-table th {
            background-color: #e9ecef;
            position: sticky;
            top: 0;
            z-index: 2;
            font-weight: bold;
        }
        
        #data-table th:first-child {
            position: sticky;
            left: 0;
            background-color: #e9ecef;
            z-index: 3;
        }

        #data-table tbody td:first-child {
            position: sticky;
            left: 0;
            background-color: #f8f9fa;
            font-weight: bold;
            z-index: 1;
        }

        #data-table td.selected {
            background-color: var(--selected-color);
            outline: 2px solid var(--primary-color);
            outline-offset: -2px;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .controls button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .controls button#increment {
            background-color: var(--success-color);
        }

        .controls button#decrement {
            background-color: var(--danger-color);
        }
        
        .file-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .file-buttons button {
            padding: 10px 20px;
            border-radius: 5px;
            border: 1px solid var(--secondary-color);
            background-color: white;
            color: var(--secondary-color);
            cursor: pointer;
        }
        
        .file-buttons input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <label for="start-time">Start Time:</label>
            <input type="time" id="start-time" value="09:00">
            <label for="end-time">End Time:</label>
            <input type="time" id="end-time" value="17:00">
            <button id="generate-btn">Generate</button>
            <div id="time-interval"></div>
        </div>

        <div class="table-container">
            <table id="data-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Person/vehicle in</th>
                        <th>Person/vehicle out</th>
                        <th>Delivery person/commercial vehicle in</th>
                        <th>Delivery person/commercial vehicle out</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="controls">
            <button id="decrement">-</button>
            <button id="increment">+</button>
        </div>
        
        <div class="file-buttons">
            <button id="export-btn">Export to CSV</button>
            <input type="file" id="import-file-input" accept=".csv">
            <button id="import-btn">Import CSV</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const startTimeInput = document.getElementById('start-time');
            const endTimeInput = document.getElementById('end-time');
            const generateBtn = document.getElementById('generate-btn');
            const timeIntervalDisplay = document.getElementById('time-interval');
            const tableBody = document.querySelector('#data-table tbody');
            const tableContainer = document.querySelector('.table-container');
            const dataTable = document.getElementById('data-table');
            const incrementBtn = document.getElementById('increment');
            const decrementBtn = document.getElementById('decrement');
            const exportBtn = document.getElementById('export-btn');
            const importBtn = document.getElementById('import-btn');
            const importFileInput = document.getElementById('import-file-input');

            let selectedCell = null;

            // PWA Service Worker Registration (requires a separate file)
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    // This is commented out as the request is for a single HTML file.
                    /*
                    navigator.serviceWorker.register('/service-worker.js').then(registration => {
                        console.log('SW registered: ', registration);
                    }).catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
                    */
                });
            }

            function parseTime(timeString) {
                const [hours, minutes] = timeString.split(':').map(Number);
                return hours * 60 + minutes;
            }

            function formatTime(minutes) {
                const hours = Math.floor(minutes / 60) % 24;
                const mins = minutes % 60;
                const paddedHours = String(hours).padStart(2, '0');
                const paddedMins = String(mins).padStart(2, '0');
                return `${paddedHours}:${paddedMins}`;
            }

            function calculateInterval(start, end) {
                const startMinutes = parseTime(start);
                const endMinutes = parseTime(end);
                let diff = endMinutes - startMinutes;
                if (diff < 0) {
                    diff += 24 * 60;
                }
                const hours = Math.floor(diff / 60);
                const minutes = diff % 60;
                return `${hours}h ${minutes}m`;
            }

            function generateTable() {
                const startTime = startTimeInput.value;
                const endTime = endTimeInput.value;
                const startMinutes = parseTime(startTime);
                const endMinutes = parseTime(endTime);
                
                timeIntervalDisplay.textContent = calculateInterval(startTime, endTime);
                tableBody.innerHTML = '';
                selectedCell = null;

                const timePoints = [0, 16, 31, 46];
                
                let currentMinutes = startMinutes;
                const finalMinutes = endMinutes > startMinutes ? endMinutes : endMinutes + 24 * 60;

                while (currentMinutes < finalMinutes) {
                    const minuteOfHour = currentMinutes % 60;
                    if (timePoints.includes(minuteOfHour)) {
                         const timeString = formatTime(currentMinutes);
                         const row = document.createElement('tr');
                         row.innerHTML = `
                             <td>${timeString}</td>
                             <td contenteditable="true">0</td>
                             <td contenteditable="true">0</td>
                             <td contenteditable="true">0</td>
                             <td contenteditable="true">0</td>
                         `;
                         tableBody.appendChild(row);
                    }
                    currentMinutes++;
                }
                
                addCellClickListeners();
            }

            function addCellClickListeners() {
                const dataCells = tableBody.querySelectorAll('td:not(:first-child)');
                dataCells.forEach(cell => {
                    cell.addEventListener('click', () => {
                        if (selectedCell) {
                            selectedCell.classList.remove('selected');
                        }
                        selectedCell = cell;
                        selectedCell.classList.add('selected');
                    });
                });
            }

            function adjustValue(delta) {
                if (!selectedCell) {
                    alert('Please select a cell first.');
                    return;
                }
                let currentValue = parseInt(selectedCell.textContent, 10);
                let newValue = currentValue + delta;
                if (newValue < 0) {
                    newValue = 0;
                }
                selectedCell.textContent = newValue;
            }

            function exportToCsv() {
                const rows = document.querySelectorAll("#data-table tr");
                const csv = [];
                for (let i = 0; i < rows.length; i++) {
                    const row = [], cols = rows[i].querySelectorAll("td, th");
                    for (let j = 0; j < cols.length; j++) {
                        let cellText = cols[j].innerText.replace(/"/g, '""');
                        if (cellText.includes(',') || cellText.includes('\n') || cellText.includes('"')) {
                            cellText = `"${cellText}"`;
                        }
                        row.push(cellText);
                    }
                    csv.push(row.join(","));
                }
                const csvString = csv.join("\n");
                
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', 'counting_sheet.csv');
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }

            function importFromCsv(event) {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    const contents = e.target.result;
                    const lines = contents.split('\n').map(line => line.trim()).filter(line => line);
                    const headerRow = lines[0].split(',').map(h => h.replace(/^"|"$/g, '').trim());

                    const expectedHeaders = ["Time", "Person/vehicle in", "Person/vehicle out", "Delivery person/commercial vehicle in", "Delivery person/commercial vehicle out"];
                    if (JSON.stringify(headerRow) !== JSON.stringify(expectedHeaders)) {
                        alert("Error: The CSV file headers do not match the expected format.");
                        return;
                    }

                    tableBody.innerHTML = '';
                    for (let i = 1; i < lines.length; i++) {
                        const rowData = lines[i].split(',').map(d => d.replace(/^"|"$/g, '').trim());
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${rowData[0]}</td>
                            <td contenteditable="true">${rowData[1] || '0'}</td>
                            <td contenteditable="true">${rowData[2] || '0'}</td>
                            <td contenteditable="true">${rowData[3] || '0'}</td>
                            <td contenteditable="true">${rowData[4] || '0'}</td>
                        `;
                        tableBody.appendChild(row);
                    }
                    addCellClickListeners();
                };
                reader.readAsText(file);
            }

            // Pinch-to-zoom and mouse wheel zoom functionality
            let scale = 1;
            tableContainer.addEventListener('wheel', (event) => {
                event.preventDefault();
                scale += event.deltaY * -0.01;
                scale = Math.min(Math.max(0.5, scale), 3);
                dataTable.style.transform = `scale(${scale})`;
            });
            
            let lastDist = 0;
            tableContainer.addEventListener('touchstart', (event) => {
                if (event.touches.length === 2) {
                    lastDist = Math.hypot(
                        event.touches[1].pageX - event.touches[0].pageX,
                        event.touches[1].pageY - event.touches[0].pageY
                    );
                }
            });

            tableContainer.addEventListener('touchmove', (event) => {
                if (event.touches.length === 2) {
                    const dist = Math.hypot(
                        event.touches[1].pageX - event.touches[0].pageX,
                        event.touches[1].pageY - event.touches[0].pageY
                    );
                    const delta = dist - lastDist;
                    scale += delta * 0.005;
                    scale = Math.min(Math.max(0.5, scale), 3);
                    dataTable.style.transform = `scale(${scale})`;
                    lastDist = dist;
                    event.preventDefault();
                }
            });

            // Event Listeners
            generateBtn.addEventListener('click', generateTable);
            incrementBtn.addEventListener('click', () => adjustValue(1));
            decrementBtn.addEventListener('click', () => adjustValue(-1));
            exportBtn.addEventListener('click', exportToCsv);
            importBtn.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', importFromCsv);

            // Initial generation on page load
            generateTable();
        });
    </script>
</body>
</html>
